---
title: "Open and clean WMO data"
author: "Jonathan Bourne"
date: "11. oktober 2015"
output: html_document
---

This document will contain the code that can be used to open and the WMO files and extract the data

summaries to take mean, varience total number

Load packages
```{r}

packages <- c("dplyr", "tidyr", "magrittr", "openxlsx", "caret")

lapply(packages, library, character.only = TRUE)


file.loc <-file.path("~","Benchmarking", "PA consulting", "2015", "Statkraft") #file location may be computer specific depending on network
setwd(file.loc)
```

#Extract relevant sheets as data frames

extraction functions
```{r}

powerplant <- function(filename, company) {
  power_plant_level <- read.xlsx(filename, sheet = "T Part A - Power plant level", startRow = 12, colNames = FALSE )[,1:26]
  
  names(power_plant_level) <- read.xlsx(filename, sheet = "T Part A - Power plant level" ,
                                        startRow = 8, rows = 8:9)[,-c(1,27,28)]%>% 
    names  %>% gsub("/|\\-|\\?", "",.)
  power_plant_level %<>% filter(!is.na(Station.ID))
   power_plant_level$Station.ID <- paste(company, power_plant_level$Station.ID, sep = "" )
 names(power_plant_level) <- gsub("\\?","", names(power_plant_level))
  power_plant_level 
}

gen_spec <- function(filename, company){
gen_spec <- read.xlsx(filename, sheet = "T part B - Spec. generator" , startRow = 12, colNames = FALSE )[,1:16]

names(gen_spec) <-  read.xlsx(filename, sheet = "T part B - Spec. generator" , 
                             startRow = 8, rows = 8:9)[,2:17]%>% 
                    names %>% gsub("\\?|\\/|\\(|\\)", "",.) #the ? are being read as Regex and so are removed from the headings, they could be escaed but are superflous anyway.
gen_spec %<>% filter(!is.na(Station.ID))
gen_spec$Station.ID <- paste(company, gen_spec$Station.ID, sep = "" )
catag <-c("Turbine.type","Reversible.pump.turbine","Turbine.with.2.or.more.runners","Water.cooled.windings")
gen_spec %<>%mutate_each_(funs(factor),catag) %>% 
          group_by(Station.ID) %>% 
          mutate(specID = 1, specID = paste(Station.ID,"_",cumsum(specID),sep="")) %>% 
  ungroup  
gen_spec
}

dam_spec <- function(filename, company) {
    dam_spec <- read.xlsx(filename, sheet = "T part C - Spec. reservoir, EBI", startRow = 12, colNames = FALSE )[,2:11]

    names(dam_spec) <- read.xlsx(filename, sheet = "T part C - Spec. reservoir, EBI", startRow = 8, rows = 8:9)[,2:11]%>% 
      names %>% gsub("\\?|\\/|\\(|\\)", "",.) #the ? are being read as Regex and so are removed from the headings, they could be escaed but are superflous anyway.
    dam_spec %<>% filter(!is.na(Station.ID))
    dam_spec$Station.ID <- paste(company, dam_spec$Station.ID, sep = "" )
    names(dam_spec)[6] <- "Distance.from.roads"
    catag <- c("Object.ID","Dam.or.Riverstream.intake.EBI","Altitude.above.sea.level"  ,"Climate.zone" ,"Dam.classification")
    dam_spec %<>% mutate_each_(funs(factor),catag) %>% 
          group_by(Station.ID) %>% 
          mutate(specID = 1, specID = paste(Station.ID,"_",cumsum(specID),sep="")) %>% 
          ungroup 
dam_spec
}

gates_spec <- function(filename, company) {
      gates_spec <- read.xlsx(filename, sheet = "T part D - Spec. gates above gr", startRow = 12, colNames = FALSE )[,1:9]

      names(gates_spec) <- read.xlsx(filename, sheet = "T part D - Spec. gates above gr", 
                               startRow = 8, rows = 8:9)[,2:10]%>% names %>% gsub("\\?|\\/", "",.)
      gates_spec %<>% filter(!is.na(Station.ID))
      gates_spec$Station.ID <- paste(company, gates_spec$Station.ID, sep = "" )
#names(gates_spec) <- gsub("\\?","", names(gates_spec))
      gates_spec$Object.ID <- gates_spec$Object.ID[sub(",", "", gates_spec$Object.ID)] # commas were causing problems with the csv import, even though they were strings.
      catag <- c("SectorRadial.gate","Flood.gate")
      gates_spec %<>% mutate_each_(funs(factor),catag) %>% 
          group_by(Station.ID) %>% 
          mutate(specID = 1, specID = paste(Station.ID,"_",cumsum(specID),sep="")) %>% 
          ungroup  
gates_spec
}

valves_spec <- function(filename, company) {
  valves_spec <- read.xlsx(filename, sheet = "T part E - Spec. valves", startRow = 12, colNames = FALSE )[,1:5]

names(valves_spec) <- read.xlsx(filename, sheet = "T part E - Spec. valves", startRow = 8, rows = 8:9)[,2:6]%>% names %>% gsub("\\?", "",.) #the ? are being read as Regex and so are removed from the headings.
valves_spec %<>% filter(!is.na(Station.ID)) #prevents loads of empty lines being imported
valves_spec$Station.ID <- paste(company, valves_spec$Station.ID, sep = "" )
# valves does not have any catagorical values to rollup
valves_spec %<>%  group_by(Station.ID) %>% 
                  mutate(specID = 1, specID = paste(Station.ID,"_",cumsum(specID),sep="")) %>%
                  ungroup 
valves_spec
}

rollup <- function(dataframe){
        dataframe %>% 
              group_by(Station.ID) %>% 
              mutate(count = n()) %>% 
              summarise_each_(funs(mean, max, min, sum, var), 
                  names(.)[sapply(., class)=="numeric"|sapply(., class)=="integer"])
}

catagoricals <- function(data) {
data <-  data %>% select(1,length(.),which(sapply(., class)=="factor"))

#split out catagorical values and replace rogue J's with Y remove NA values
data2 <- data %>% gather(variable, class, -c(Station.ID,specID))
data2$class <- sub("^J$", "Y", data2$class)
data2 %<>%  mutate(present = 1, variable = paste(variable, "_",class, sep="")) %>%
            select(-class) %>% 
            spread(variable, present, fill = 0) %>% select(-specID) %>%
  mutate(x_NA = 1) #this additional column prevents a bug on the next command which is if there area no columns ending in _NA all columns are removed.

data2 %<>% select(-ends_with("_NA"))

##Aggregate up all the values into a single powerplant
data2 %<>% group_by(Station.ID) %>% summarise_each(funs(sum))
}

aggregator <- function(data) {
  if (length(which(sapply(data, class)=="factor"))!=0){  
  rolled <- rollup(data)
  catag <- catagoricals(data)
  data <- full_join(rolled, catag, by = "Station.ID")
  } else {data <- rollup(data)}
    data
}

combinatron <- function(filename, comapanyname){
plantspec <- powerplant(filename, comapanyname) %>% aggregator
genspec <- gen_spec(filename, comapanyname) %>% aggregator
damspec <- dam_spec(filename, comapanyname) %>% aggregator
gatespec <- gates_spec(filename, comapanyname) %>% aggregator
valvespec <- valves_spec(filename, comapanyname) %>% aggregator
plantspec %<>% full_join(., genspec ,by="Station.ID") %>% 
                full_join(., damspec ,by="Station.ID") %>%
                full_join(., gatespec ,by="Station.ID") %>%
                full_join(.,valvespec,by="Station.ID")
plantspec
}

```

Load and combine files
```{r}
filename <- "Data Gathering Sheet 2015 V2.xlsx"
company <- "Statkraft"
triplex <- combinatron(filename, company)


stat_names <- c("statkraft_powerplant", "statkraft_genspec", "statkraft_damspec", "statkraft_gatespec", "statkraft_valvespec")

eco <- combinatron("ECO 2014.xlsx", "ECO")

eidsiva <- combinatron("Eidsiva 2013 DD1 (31.04.2014).xlsx","Eidsiva")
filename2 <- "Eidsiva 2013 DD1 (31.04.2014).xlsx"
company2 <- "Eidsiva"

plant_spec <- powerplant(filename, company) %>%aggregator
genspec <- gen_spec(filename, company) %>%aggregator
damspec <- dam_spec(filename, company)%>%aggregator
gatespec <- gates_spec(filename, company) %>%aggregator
valvespec <- valves_spec(filename, company)%>%aggregator

#filename <- filename2
#company <- company2
plant_spec2 <- powerplant(filename2, company2) %>%aggregator
genspec2 <- gen_spec(filename2, company2)%>%aggregator
damspec2 <- dam_spec(filename2, company2) %>%aggregator
gatespec2 <- gates_spec(filename2, company2)  %>%aggregator
valvespec2 <- valves_spec(filename2, company2)  %>%aggregator

test <- bind_rows(triplex, eidsiva, eco) #
test[is.na(test)] <- 0
test %<>%  mutate_each(funs(numeric),names(.)[sapply(., class)=="integer"])

cortest <-cor(test[,-1])
hc = findCorrelation(cortest, cutoff=0.8)
names(.)[sapply(., class)=="numeric"|sapply(., class)=="integer"]
```

merge in costs
```{r}
company2= "Eidsiva"
eidscostfile <- "Kostnadsanalyser Statkraft, Eidsiva-data 2009-2014 (FBi_06-11-2015).xlsx"

costjoiner <- function(company, costfile){
  cost <-read.xlsx(costfile, startRow=5)[,c(5,33:38)]
  cost %<>% rename(Station.ID= X5) %>%filter(!is.na(Station.ID))
  cost$Station.ID <- paste(company, cost$Station.ID, sep = "" )
names(cost)[2:7] <- paste("year_",names(cost)[2:7], sep="")
cost %<>% mutate(yr2014avg= (year_2014+year_2013+year_2012)/4) %>%select(Station.ID, yr2014avg)

}

eidscost <-costjoiner(company2, eidscostfile)
ecocost <- costjoiner("eco","E-CO Energi Rapporteringsskjema 2010 - 2014.xlsx")
x <-read.xlsx("E-CO Energi Rapporteringsskjema 2010 - 2014.xlsx")
x2 <-read.xlsx("E-CO Energi Rapporteringsskjema 2010 - 2014.xlsx", startRow=5)[,c(5,33:38)]

```

Remove empty variables or nearly empty variables
```{r}

```


Remove Highly correlated variables
```{r}

```

Add Cost and WMO data
```{r}

```

Model WMO accuracy
```{r}

```

Create variety of statistical models
```{r}

```


```{r}
names(genspec2)[!(names(genspec2) %in% names(genspec))]
names(plant_spec2)[!(names(plant_spec2) %in% names(plant_spec))]
names(triplex)[!(names(eidsiva) %in% names(triplex))]

x1 <- bind_rows(genspec, genspec2)
x2 <- bind_rows(plant_spec, plant_spec2)
x3 <- bind_rows(damspec2,damspec)
x4 <- bind_rows(valvespec2,valvespec)
x5 <- bind_rows(gatespec, gatespec2)

x <- x1 %>% full_join(x2) %>% full_join(x3) %>% full_join(x4) %>% full_join(x5)

```


```{r}
data1 <- data.frame(data1=runif(10),data2=runif(10),data4=runif(10))
data2 <- data.frame(data1=runif(10),data3=runif(10),data5=runif(10))

datatotal <- bind_rows(data1,data2)
```


\newpage

#Abstract

#Introdution
The WMO has been used in Norway since the the early 2000's as a way of normalising costs between Power Plants of different physical characteristics. It is the defacto standard within Norway and has some use in other Countries within the Nordics. An area of difficulty within the WMO is that the concept of a Weighted Maintenance Object is entirely abstract having no real expression in measurable reality. In addition the way that the total WMO's per Power Plant is calculated is extremly convulated and a mathmatical definition of the model doesn't exist. This has made it very difficult to measure how effective the model is at capturing the varience between Power Plants. In order to understand the WMO it is necessary to understand its development.The model was developed by Statkraft, Norway's largest Power Company, together with PA consulting. At the time the model was developed Statkraft wasn't able to produce cost data down to the granularity of a Power Plant but to the level of a so called 'Power Plant Group'. A Power Plant Group are a collection of distinct Power Plants that share geographical proximity, they may also share hydrological resources.In order to get around this problem the Weighted Maintenance Object was invented.

A WMO is a unit of maintenance complexity, the idea being that the number of WMO's is proportional to the amount of maintenance that a Power Plant needs and therefore the amount of money that is required to maintain it. It was beleived that by calculating the total Number of WMO's per Power Plant group and finding the ratio of WMO's to spend on maintenance it would then be possible to compare the cost effectiveness of different Power Plants or groups using this newly created metric. The method of creation of WMO's is partially statistical partially expert based. Work by Sintef **find ref** found a relationship between generator size, quantity and maintenance cost, and this work was used to create part of the system which accounts for approximately 60% of the total amount of WMO's across the portfolio (based on Statkraft data only). The remainder of the WMO's area generated by an algorithm whose coefficients are decided by experts. Whilst there is some testing of the variables, it is based on univariate analysis and so the results are at best difficult to interpret.
#Method
##Data source
##Data cleaning and aggregation

#Results
Include a chart that shows a boxplot of the top 5 contributers to the WMO over the whole portfolio
#conclusions

#Appendix