---
title: "Open and clean WMO data"
author: "Jonathan Bourne"
date: "11. oktober 2015"
output: html_document
---

This document will contain the code that can be used to open and the WMO files and extract the data

summaries to take mean, varience total number

Load packages
```{r}

packages <- c("dplyr", "tidyr", "magrittr", "openxlsx")

lapply(packages, library, character.only = TRUE)


file.loc <-file.path("~","Benchmarking", "PA consulting", "2015", "Statkraft") #file location may be computer specific depending on network
setwd(file.loc)
```

#Extract relevant sheets as data frames

extraction functions
```{r}

powerplant <- function(filename) {
  power_plant_level <- read.xlsx(filename, sheet = "T Part A - Power plant level", startRow = 12, colNames = FALSE )
  
  names(power_plant_level) <- read.xlsx(filename, sheet = "T Part A - Power plant level" , startRow = 8, rows = 8:9)[,-c(1,27,28)]%>% names  %>% sub("/", "",.)
 names(power_plant_level[9]) <- "StorageRoR" ##why doesnt this work?
  power_plant_level 
}

gen_spec <- function(filename){
gen_spec <- read.xlsx(filename, sheet = "T part B - Spec. generator" , startRow = 12, colNames = FALSE )[,1:16]

names(gen_spec) <- read.xlsx(filename, sheet = "T part B - Spec. generator" , startRow = 8, rows = 8:9)[,2:17]%>% names
gen_spec

}

dam_spec <- function(filename) {
  dam_spec <- read.xlsx(filename, sheet = "T part C - Spec. reservoir, EBI", startRow = 12, colNames = FALSE )[,2:11]

names(dam_spec) <- read.xlsx(filename, sheet = "T part C - Spec. reservoir, EBI", startRow = 8, rows = 8:9)[,2:11]%>% names
dam_spec
}

gates_spec <- function(filename) {
gates_spec <- read.xlsx(filename, sheet = "T part D - Spec. gates above gr", startRow = 12, colNames = FALSE )

names(gates_spec) <- read.xlsx(filename, sheet = "T part D - Spec. gates above gr", startRow = 8, rows = 8:9)[,2:10]%>% names %>% sub("/", "",.)
gates_spec
}

valves_spec <- function(filename) {
  valves_spec <- read.xlsx(filename, sheet = "T part E - Spec. valves", startRow = 12, colNames = FALSE )

names(valves_spec) <- read.xlsx(filename, sheet = "T part E - Spec. valves", startRow = 8, rows = 8:9)[,2:6]%>% names
valves_spec
}

```

Statkraft files
```{r}
filename <- "Data Gathering Sheet 2015 V2.xlsx"
statkraft_powerplant <- powerplant(filename)
statkraft_genspec <- gen_spec(filename)
statkraft_damspec <- dam_spec(filename)
statkraft_gatespec <- gates_spec(filename)
statkraft_valvespec <- valves_spec(filename)

stat_names <- c("statkraft_powerplant", "statkraft_genspec", "statkraft_damspec", "statkraft_gatespec", "statkraft_valvespec")

statkraft <- lapply(stat_names, function(n) eval(parse(text=n)))
names(statkraft) <- stat_names

lapply(stat_names, function(n) write.csv(eval(parse(text=n)), 
                                         paste(n, ".csv", sep=""), 
                                         row.names = FALSE)
       )

#write.xlsx(statkraft, file = "Statkraft.xlsx")

#write.xlsx(statkraft_powerplant, file = "power.xlsx")

```
